{% extends 'App/base.html' %}
{% load static %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% block content %}

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/Result.css">
    <title>Result</title>
</head>

<body>
    <div class="container-fluid my-5" style="overflow: hidden;">
        <!-- video section -->
        <div class="row gx-5">
            <div class="col-md-6">
                {% if videos %}
                {% for video in videos %}
                <!-- YouTube video details -->
                <div class="col-md-12 mb-5">
                    <!-- Video container -->
                    <div class="row">
                        <!-- Picture section -->
                        <div class="col-md-5">
                            <div class="pic">
                                <!-- Video thumbnail -->
                                <img src="{{ video.thumbnail }}" alt="Thumbnail" class="img-fluid"
                                    style="width: 100%; height: auto;">
                            </div>
                        </div>
                        <!-- Text section -->
                        <div class="col-md-7">
                            <!-- Right-side video text section -->
                            <div class="row">
                                <!-- Upper text section -->
                                <div class="col-md-12">
                                    <div class="text">
                                        <p><strong>{{ video.title }}</strong></p>
                                    </div>
                                </div>
                                <!-- Picture and text YouTube -->
                                <div class="col-md-12">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#F01111"
                                        class="bi bi-play-btn" viewBox="0 0 16 16">
                                        <path
                                            d="M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814z" />
                                        <path
                                            d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 0a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z" />
                                    </svg>
                                    <a href="{{ video.url }}" target="_blank"
                                        style="text-decoration: none; color: #F01111;">Watch Video</a>
                                </div>
                            </div>
                            <!-- Description -->
                            <div class="col-md-12 mt-2">
                                <div class="text">
                                    <p>{{ video.description }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p>No results found for your search.</p>
                {% endif %}
            </div>

            <!-- right side container where content will be generated -->
            <div class="  col-md-5 ">
                <!-- upper section where logo and other content will be included -->
                <div class="row right-container "
                    style="background-color: aliceblue; border-radius: 10px; border: 1px solid black;">
                    <!-- image section -->
                    <div class="row gy-2 gx-5 align-items-center">
                        <div class="col-md-6 col-6 ">
                            <img src="/static/images/a.ico" alt="" width="50" height="50">
                        </div>
                        <div class="col-md-6 col-6 d-flex justify-content-end">
                            <img src="/static/images/icons/aim.png" alt="" width="30" height="30">
                            <img src="/static/images/icons/aim.png" alt="" width="30" height="30">
                            <img src="/static/images/icons/aim.png" alt="" width="30" height="30">
                        </div>
                    </div>

                    <!-- Summary section -->
                    <div class="col-md-11 gx-5 gy-5">
                        <div class="overview">
                            <h3>Summary</h3>
                            <div id="combined-summary-container">
                                {% if combined_summary %}
                                    <p style="font-size: smaller;" class="my-4">{{ combined_summary }}</p>
                                {% else %}
                                    <p style="font-size: smaller;" class="my-4" id="loading-combined-summary">
                                        Generating summary... Please wait...
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Guide section -->
                    <div class="row d-flex align-items-center justify-content-between">
                        <h3 class="mx-2 d-flex align-items-center">
                            Guide
                        </h3>
                        <p style="font-size: smaller;" class="my-3 mx-2">Here is detailed Guide you need, feel free to ask any question.</p>

                        <div id="audioContainer" style="display: none;">
                            <audio id="guideAudio" controlsList="nodownload">
                                <source src="" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                            <span class="d-flex align-items-center ms-auto">
                                <button id="audioControl" class="btn mx-2 d-flex align-items-center justify-content-center"
                                        style="width: 40px; height: 40px; padding: 0; border-radius: 5px; background-color: #007bff;"
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Listen to Guide">
                                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#FFFFFF" class="bi bi-volume-up-fill" viewBox="0 0 16 16">
                                        <path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/>
                                        <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/>
                                        <path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06"/>
                                    </svg>
                                    <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#FFFFFF" class="bi bi-pause-circle" viewBox="0 0 16 16" style="display: none;">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                        <path d="M5 6.25a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0zm3.5 0a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0z"/>
                                    </svg>
                                </button>
                            
                       
                           
                           <!-- Download Icon with Tooltip -->
                           <button id="download" class="btn mx-2 d-flex align-items-center justify-content-center"
                           style=" width: 40px; height: 40px; padding: 0;  border-radius: 8px;"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="Listen to Guide">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#FFFFFF" class="bi bi-file-earmark-arrow-down-fill" viewBox="0 0 16 16">
                                   <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1m-1 4v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 11.293V7.5a.5.5 0 0 1 1 0"/>
                               </svg>
                           </button>
                       </span>
                       
                   </div>
                
                    <div class="summary-text row mx-5" style="width: 80%;">
                        <div id="guide-content">
                            {% if guide_content %}
                                {{ guide_content|safe }}
                            {% else %}
                                <p class="guide text-color">Generating detailed guide... Please wait</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Query input -->
                    <div class="row my-5 justify-content-center">
                        <div class="input-group" style="width: 90%;">
                            <!-- Query input field -->
                            <input type="text" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp"
                                placeholder="Ask Anything">
                            <!-- Search button inside the input field -->
                            <button type="button" class="btn "onclick="">Search</button>

                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

{{ search_query_id|json_script:"search-query-id" }}

<script>
function checkContentStatus() {
    const searchId = JSON.parse(document.getElementById('search-query-id').textContent);
    
    fetch(`/check-content/?search_query_id=${searchId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update summary if ready
            if (data.summary) {
                const summaryContainer = document.getElementById('loading-combined-summary');
                if (summaryContainer) {
                    summaryContainer.textContent = data.summary;
                }
            }
            
            // Update guide if ready
            if (data.guide) {
                const guideContainer = document.getElementById('guide-content');
                if (guideContainer && guideContainer.textContent.includes('Generating')) {
                    guideContainer.innerHTML = data.guide;
                }
            }
            
            // Update audio if ready
            if (data.audio_url) {
                const audioContainer = document.getElementById('audioContainer');
                const guideAudio = document.getElementById('guideAudio');
                
                if (audioContainer && guideAudio) {
                    audioContainer.style.display = 'block';
                    guideAudio.querySelector('source').src = data.audio_url;
                    guideAudio.load(); // Important: reload the audio element
                }
            }
            
            // Continue checking if either content is not ready
            if (!data.summary_ready || !data.guide_ready) {
                setTimeout(checkContentStatus, 5000); // Check every 5 seconds
            }
        })
        .catch(error => {
            console.error('Error checking content:', error);
            setTimeout(checkContentStatus, 5000);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    checkContentStatus();
    
    const audioControl = document.getElementById('audioControl');
    const guideAudio = document.getElementById('guideAudio');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');

    if (audioControl && guideAudio) {
        audioControl.addEventListener('click', function() {
            if (guideAudio.paused) {
                // Add error handling for play()
                guideAudio.play().catch(error => {
                    console.error('Error playing audio:', error);
                });
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                guideAudio.pause();
                pauseIcon.style.display = 'none';
                playIcon.style.display = 'block';
            }
        });

        guideAudio.addEventListener('ended', function() {
            pauseIcon.style.display = 'none';
            playIcon.style.display = 'block';
        });

        // Add error handling for audio loading
        guideAudio.addEventListener('error', function(e) {
            console.error('Error loading audio:', e);
            audioControl.style.display = 'none';
        });
    }
});
</script>
                    

    
</body>

</html>


{% endblock %}